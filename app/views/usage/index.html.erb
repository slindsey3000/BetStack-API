<% content_for :title, "API Usage Dashboard - BetStack" %>

<style>
  .usage-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
    padding: 3rem 0;
    margin-bottom: 2rem;
  }
  .usage-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
  }
  .usage-header p {
    opacity: 0.8;
    font-size: 1.1rem;
  }
  .section-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #667eea;
  }
  .section-title h2 {
    margin: 0;
    color: #1a1a2e;
  }
  .section-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
  }
  .client-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .internal-icon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
  .usage-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid #e5e7eb;
  }
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .stat-box {
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    border: 1px solid #e0e5f0;
  }
  .stat-box.highlight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }
  .stat-box.danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
    color: white;
    border: none;
  }
  .stat-box .number {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.2;
  }
  .stat-box .label {
    font-size: 0.85rem;
    opacity: 0.8;
    margin-top: 0.25rem;
  }
  .stat-box.highlight .label,
  .stat-box.danger .label {
    opacity: 0.9;
  }
  .data-table {
    width: 100%;
    border-collapse: collapse;
  }
  .data-table th {
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
  }
  .data-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f0f0f0;
  }
  .data-table tr:hover {
    background: #f8f9ff;
  }
  .data-table .numeric {
    text-align: right;
    font-family: 'SF Mono', 'Monaco', monospace;
  }
  .email-cell {
    font-family: 'SF Mono', 'Monaco', monospace;
    font-size: 0.9rem;
    color: #667eea;
  }
  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge-success { background: #d1fae5; color: #065f46; }
  .badge-warning { background: #fef3c7; color: #92400e; }
  .badge-danger { background: #fee2e2; color: #991b1b; }
  .badge-info { background: #dbeafe; color: #1e40af; }
  .info-banner {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
    border-left: 4px solid #667eea;
    border-radius: 8px;
    padding: 1.25rem;
    margin-top: 2rem;
  }
  .info-banner h3 {
    margin: 0 0 0.75rem;
    color: #1a1a2e;
  }
  .info-banner p {
    margin: 0.5rem 0;
    color: #4b5563;
    font-size: 0.95rem;
  }
  .section-divider {
    margin: 3rem 0;
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, #e5e7eb, transparent);
  }
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #9ca3af;
  }
  .empty-state svg {
    width: 48px;
    height: 48px;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
</style>

<div class="usage-header">
  <div class="container">
    <h1>üìä API Usage Dashboard</h1>
    <p>Real-time monitoring of BetStack API usage and performance</p>
  </div>
</div>

<div class="container">
  <!-- ==================== CLIENT API USAGE ==================== -->
  <div class="section-title">
    <div class="section-icon client-icon">üë•</div>
    <h2>Client API Usage</h2>
  </div>
  
  <div class="usage-card">
    <div class="stats-row">
      <div class="stat-box highlight">
        <div class="number"><%= number_with_delimiter(@client_today_requests || 0) %></div>
        <div class="label">Today's Requests</div>
      </div>
      <div class="stat-box <%= (@client_today_rejected || 0) > 0 ? 'danger' : '' %>">
        <div class="number"><%= number_with_delimiter(@client_today_rejected || 0) %></div>
        <div class="label">Today's Rejected</div>
      </div>
      <div class="stat-box">
        <div class="number"><%= number_with_delimiter(@client_month_requests || 0) %></div>
        <div class="label"><%= Date.current.strftime('%B') %> Total</div>
      </div>
    </div>
  </div>

  <!-- Usage by Email/User -->
  <% if @client_usage_by_email.present? && @client_usage_by_email.any? %>
  <div class="usage-card">
    <h3 style="margin-top: 0; margin-bottom: 1rem; color: #374151;">üìß Usage by Account (Last 30 Days)</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Account</th>
          <th class="numeric">Requests</th>
          <th class="numeric">Rejected</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% @client_usage_by_email.each do |usage| %>
          <tr>
            <td class="email-cell"><%= obfuscate_email(usage[:email]) %></td>
            <td class="numeric"><%= number_with_delimiter(usage[:requests]) %></td>
            <td class="numeric" style="color: <%= usage[:rejected] > 0 ? '#dc2626' : '#16a34a' %>;"><%= number_with_delimiter(usage[:rejected]) %></td>
            <td>
              <% if usage[:rejected] > 50 %>
                <span class="status-badge badge-danger">Abuse</span>
              <% elsif usage[:rejected] > 10 %>
                <span class="status-badge badge-warning">Warning</span>
              <% elsif usage[:requests] > 100 %>
                <span class="status-badge badge-info">Active</span>
              <% else %>
                <span class="status-badge badge-success">Normal</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <% end %>

  <!-- Client Daily Breakdown -->
  <% if @client_daily_breakdown.present? && @client_daily_breakdown.any? %>
  <div class="usage-card">
    <h3 style="margin-top: 0; margin-bottom: 1rem; color: #374151;">üìÖ Daily Request History</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th class="numeric">Requests</th>
          <th class="numeric">Rejected</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <% @client_daily_breakdown.first(14).each do |date, data| %>
          <tr>
            <td><strong><%= date.strftime('%b %d, %Y') %></strong></td>
            <td class="numeric"><%= number_with_delimiter(data[:requests] || 0) %></td>
            <td class="numeric" style="color: <%= (data[:rejected] || 0) > 0 ? '#dc2626' : '#16a34a' %>;"><%= number_with_delimiter(data[:rejected] || 0) %></td>
            <td>
              <% if (data[:rejected] || 0) > 10 %>
                <span class="status-badge badge-warning">Abuse Detected</span>
              <% elsif (data[:requests] || 0) > 100 %>
                <span class="status-badge badge-info">Active</span>
              <% else %>
                <span class="status-badge badge-success">Normal</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <% end %>

  <hr class="section-divider">

  <!-- ==================== INTERNAL API USAGE ==================== -->
  <div class="section-title">
    <div class="section-icon internal-icon">üîå</div>
    <h2>Internal API Usage (Data Provider)</h2>
  </div>
  
  <div class="usage-card">
    <div class="stats-row">
      <div class="stat-box">
        <div class="number"><%= number_with_delimiter(@today_total) %></div>
        <div class="label">Today's Requests</div>
      </div>
      <div class="stat-box">
        <div class="number"><%= number_with_delimiter(@month_total) %></div>
        <div class="label"><%= Date.current.strftime('%B') %> Total</div>
      </div>
      <div class="stat-box">
        <div class="number"><%= number_with_delimiter(@avg_daily_last_30) %></div>
        <div class="label">Daily Average (30d)</div>
      </div>
      <div class="stat-box">
        <div class="number"><%= number_with_delimiter(@projected_monthly) %></div>
        <div class="label">Projected Monthly</div>
      </div>
    </div>
  </div>

  <!-- League Breakdown -->
  <% if @league_breakdown.any? %>
  <div class="usage-card">
    <h3 style="margin-top: 0; margin-bottom: 1rem; color: #374151;">üèà Usage by League (Last 30 Days)</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>League</th>
          <th class="numeric">Requests</th>
          <th class="numeric">% of Total</th>
        </tr>
      </thead>
      <tbody>
        <% total_requests = @league_breakdown.values.sum %>
        <% @league_breakdown.each do |league_key, count| %>
          <tr>
            <td><strong><%= league_key %></strong></td>
            <td class="numeric"><%= number_with_delimiter(count) %></td>
            <td class="numeric"><%= number_to_percentage((count.to_f / total_requests * 100), precision: 1) %></td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr style="font-weight: bold; background: #f8f9fa;">
          <td>Total</td>
          <td class="numeric"><%= number_with_delimiter(total_requests) %></td>
          <td class="numeric">100%</td>
        </tr>
      </tfoot>
    </table>
  </div>
  <% end %>

  <!-- Info Banner -->
  <div class="info-banner">
    <h3>‚ÑπÔ∏è About This Dashboard</h3>
    <p><strong>Client API Usage:</strong> Tracks requests from API key holders. Data synced hourly from edge. Rejected = rate-limited (1 req/60s).</p>
    <p><strong>Internal API Usage:</strong> Our requests to external data providers for odds and scores.</p>
    <p><strong>Quota:</strong> 100,000 requests/month from data provider ‚Ä¢ <strong>Retention:</strong> 90 days</p>
  </div>
</div>

<footer style="background: #1a1a2e; color: white; padding: 1.5rem 0; margin-top: 3rem;">
  <div class="container" style="text-align: center;">
    <p style="margin: 0; opacity: 0.8;">BetStack API &copy; <%= Date.current.year %> | Last updated: <%= Time.current.strftime('%b %d, %Y at %I:%M %p %Z') %></p>
  </div>
</footer>
