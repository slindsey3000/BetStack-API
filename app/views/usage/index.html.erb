<% content_for :title, "API Usage Dashboard" %>

<header>
  <div class="container">
    <h1>ðŸ“Š BetStack API Usage Dashboard</h1>
    <p>Real-time monitoring of external API request usage</p>
  </div>
</header>

<div class="container">
  <!-- Quick Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Today's Requests</h3>
      <div class="value"><%= number_with_delimiter(@today_total) %></div>
      <div class="label">API calls made today</div>
    </div>
    
    <div class="stat-card">
      <h3>This Month</h3>
      <div class="value"><%= number_with_delimiter(@month_total) %></div>
      <div class="label">Total requests in <%= Date.current.strftime('%B') %></div>
    </div>
    
    <div class="stat-card">
      <h3>Daily Average (30d)</h3>
      <div class="value"><%= number_with_delimiter(@avg_daily_last_30) %></div>
      <div class="label">Average per day</div>
    </div>
    
    <div class="stat-card">
      <h3>Projected Monthly</h3>
      <div class="value"><%= number_with_delimiter(@projected_monthly) %></div>
      <div class="label">Based on 30-day avg</div>
    </div>
  </div>

  <!-- League Breakdown -->
  <div class="card">
    <h2>Usage by League (Last 30 Days)</h2>
    <% if @league_breakdown.any? %>
      <table>
        <thead>
          <tr>
            <th>League</th>
            <th style="text-align: right;">Requests</th>
            <th style="text-align: right;">% of Total</th>
          </tr>
        </thead>
        <tbody>
          <% total_requests = @league_breakdown.values.sum %>
          <% @league_breakdown.each do |league_key, count| %>
            <tr>
              <td><strong><%= league_key %></strong></td>
              <td style="text-align: right;"><%= number_with_delimiter(count) %></td>
              <td style="text-align: right;">
                <%= number_to_percentage((count.to_f / total_requests * 100), precision: 1) %>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr style="font-weight: bold; background: #f8f9fa;">
            <td>Total</td>
            <td style="text-align: right;"><%= number_with_delimiter(total_requests) %></td>
            <td style="text-align: right;">100%</td>
          </tr>
        </tfoot>
      </table>
    <% else %>
      <p style="color: #888; padding: 20px; text-align: center;">No usage data available for the last 30 days</p>
    <% end %>
  </div>

  <!-- Daily Breakdown -->
  <div class="card">
    <h2>Daily Request History (Last 90 Days)</h2>
    <% if @daily_breakdown.any? %>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th style="text-align: right;">Requests</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% @daily_breakdown.first(90).each do |date, count| %>
            <tr>
              <td><strong><%= date.strftime('%B %d, %Y') %></strong></td>
              <td style="text-align: right;"><%= number_with_delimiter(count) %></td>
              <td>
                <% if count > 1000 %>
                  <span class="badge badge-warning">High Usage</span>
                <% elsif count > 100 %>
                  <span class="badge badge-info">Normal</span>
                <% else %>
                  <span class="badge badge-success">Low</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p style="color: #888; padding: 20px; text-align: center;">No usage data available yet</p>
    <% end %>
  </div>

  <!-- Info Box -->
  <div class="card" style="background: #f8f9fa; border-left: 4px solid #667eea;">
    <h2>About This Dashboard</h2>
    <p style="margin-bottom: 10px;">
      This dashboard tracks all external API requests from the BetStack system.
      Data is aggregated daily by league to monitor quota usage and optimize request patterns.
    </p>
    <p style="margin-bottom: 10px;">
      <strong>Current Quota:</strong> 100,000 requests per month
    </p>
    <p>
      <strong>Data Retention:</strong> 90 days of detailed logs
    </p>
  </div>
</div>

<footer>
  <div class="container">
    <p>BetStack API &copy; <%= Date.current.year %> | Last updated: <%= Time.current.strftime('%B %d, %Y at %I:%M %p %Z') %></p>
  </div>
</footer>

